#!/usr/bin/env python3
"""
çµæ´»ç”¨å·¥å¹³å° - Web ç‰ˆæœ¬
ä½¿ç”¨ Streamlit æ„å»º
"""
import streamlit as st
import json
import pandas as pd
from datetime import datetime
import os

# å°è¯•å¯¼å…¥ä½ çš„æ•°æ®ç®¡ç†å™¨
try:
    from app import DataManager
    USE_LOCAL_DATA = True
except ImportError:
    USE_LOCAL_DATA = False
    st.warning("ä½¿ç”¨å†…ç½®ç¤ºä¾‹æ•°æ®ï¼ˆæ— æ³•å¯¼å…¥ DataManagerï¼‰")

# é¡µé¢é…ç½®
st.set_page_config(
    page_title="çµæ´»ç”¨å·¥å¹³å°",
    page_icon="ğŸ¤–",
    layout="wide",
    initial_sidebar_state="expanded"
)

# è‡ªå®šä¹‰CSS
st.markdown("""
<style>
    .stApp {
        background-color: #f8f9fa;
    }
    .main-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 10px;
        margin-bottom: 2rem;
    }
    .stat-card {
        background: white;
        padding: 1.5rem;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        text-align: center;
    }
    .stat-number {
        font-size: 2rem;
        font-weight: bold;
        color: #007aff;
    }
    .stat-label {
        color: #666;
        font-size: 0.9rem;
    }
    .action-button {
        background-color: #007aff;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        text-decoration: none;
    }
    .action-button:hover {
        background-color: #0056cc;
    }
</style>
""", unsafe_allow_html=True)

# åˆå§‹åŒ–æ•°æ®ç®¡ç†å™¨
@st.cache_resource
def init_data_manager():
    if USE_LOCAL_DATA:
        return DataManager()
    return None

dm = init_data_manager()

# å¦‚æœæ— æ³•å¯¼å…¥DataManagerï¼Œä½¿ç”¨å†…ç½®æ•°æ®
if not USE_LOCAL_DATA:
    @st.cache_data
    def get_sample_data():
        jobs = [
            {"id": "job_001", "title": "å‰ç«¯å¼€å‘å·¥ç¨‹å¸ˆ", "salary": "300-500å…ƒ/å¤©", 
             "location": "è¿œç¨‹", "status": "æ‹›è˜ä¸­", "created": "2024-01-01"},
            {"id": "job_002", "title": "UIè®¾è®¡å¸ˆ", "salary": "250-400å…ƒ/å¤©", 
             "location": "ä¸Šæµ·", "status": "æ‹›è˜ä¸­", "created": "2024-01-02"},
            {"id": "job_003", "title": "Pythonåç«¯", "salary": "400-600å…ƒ/å¤©", 
             "location": "è¿œç¨‹", "status": "æ‹›è˜ä¸­", "created": "2024-01-03"},
        ]
        
        candidates = [
            {"id": "cand_001", "name": "å¼ ä¸‰", "skills": ["Python", "React", "JavaScript"],
             "experience": 3, "expected_salary": 400, "status": "å¯è”ç³»"},
            {"id": "cand_002", "name": "æå››", "skills": ["UI/UX", "Figma", "Photoshop"],
             "experience": 5, "expected_salary": 350, "status": "å¯è”ç³»"},
            {"id": "cand_003", "name": "ç‹äº”", "skills": ["Python", "Django", "PostgreSQL"],
             "experience": 4, "expected_salary": 450, "status": "å¯è”ç³»"},
        ]
        
        contracts = [
            {"id": "contract_001", "job_title": "å‰ç«¯å¼€å‘å·¥ç¨‹å¸ˆ", "candidate_name": "å¼ ä¸‰",
             "start_date": "2024-01-15", "end_date": "2024-06-15", "status": "æ‰§è¡Œä¸­",
             "total_amount": 54000},
        ]
        
        return jobs, candidates, contracts
    
    jobs, candidates, contracts = get_sample_data()
else:
    jobs = dm.jobs
    candidates = dm.candidates
    contracts = dm.contracts

# ä¾§è¾¹æ å¯¼èˆª
st.sidebar.markdown("## ğŸ¤– çµæ´»ç”¨å·¥å¹³å°")
st.sidebar.markdown("---")

page = st.sidebar.radio(
    "å¯¼èˆª",
    ["ğŸ  ä»ªè¡¨æ¿", "ğŸ“‹ èŒä½ç®¡ç†", "ğŸ‘¥ å€™é€‰äººç®¡ç†", "ğŸ“„ åˆåŒç®¡ç†", "ğŸ¯ æ™ºèƒ½åŒ¹é…", "ğŸ“Š æ•°æ®åˆ†æ"]
)

st.sidebar.markdown("---")
st.sidebar.info(f"æ•°æ®æ›´æ–°æ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")

# ==================== ä»ªè¡¨æ¿ ====================
if page == "ğŸ  ä»ªè¡¨æ¿":
    st.markdown('<div class="main-header"><h1>ğŸ  çµæ´»ç”¨å·¥ä»ªè¡¨æ¿</h1></div>', unsafe_allow_html=True)
    
    # ç»Ÿè®¡å¡ç‰‡
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        st.markdown("""
        <div class="stat-card">
            <div class="stat-number">{}</div>
            <div class="stat-label">èŒä½æ€»æ•°</div>
        </div>
        """.format(len(jobs)), unsafe_allow_html=True)
    
    with col2:
        st.markdown("""
        <div class="stat-card">
            <div class="stat-number">{}</div>
            <div class="stat-label">å€™é€‰äººæ€»æ•°</div>
        </div>
        """.format(len(candidates)), unsafe_allow_html=True)
    
    with col3:
        st.markdown("""
        <div class="stat-card">
            <div class="stat-number">{}</div>
            <div class="stat-label">åˆåŒæ€»æ•°</div>
        </div>
        """.format(len(contracts)), unsafe_allow_html=True)
    
    with col4:
        active_jobs = len([j for j in jobs if j['status'] == 'æ‹›è˜ä¸­'])
        st.markdown("""
        <div class="stat-card">
            <div class="stat-number">{}</div>
            <div class="stat-label">æ‹›è˜ä¸­èŒä½</div>
        </div>
        """.format(active_jobs), unsafe_allow_html=True)
    
    st.markdown("---")
    
    # æœ€è¿‘æ´»åŠ¨
    st.subheader("ğŸ“‹ æœ€è¿‘æ´»åŠ¨")
    
    col1, col2 = st.columns(2)
    
    with col1:
        st.markdown("**æœ€æ–°èŒä½**")
        job_df = pd.DataFrame([{
            "èŒä½": j['title'],
            "è–ªèµ„": j['salary'],
            "åœ°ç‚¹": j['location']
        } for j in jobs[:3]])
        st.dataframe(job_df, use_container_width=True)
    
    with col2:
        st.markdown("**æœ€æ–°å€™é€‰äºº**")
        candidate_df = pd.DataFrame([{
            "å§“å": c['name'],
            "æŠ€èƒ½": ", ".join(c['skills'][:2]),
            "ç»éªŒ": f"{c['experience']}å¹´"
        } for c in candidates[:3]])
        st.dataframe(candidate_df, use_container_width=True)

# ==================== èŒä½ç®¡ç† ====================
elif page == "ğŸ“‹ èŒä½ç®¡ç†":
    st.markdown('<div class="main-header"><h1>ğŸ“‹ èŒä½ç®¡ç†</h1></div>', unsafe_allow_html=True)
    
    tab1, tab2 = st.tabs(["ğŸ“‹ èŒä½åˆ—è¡¨", "â• å‘å¸ƒæ–°èŒä½"])
    
    with tab1:
        if jobs:
            job_df = pd.DataFrame(jobs)
            # åªæ˜¾ç¤ºéœ€è¦çš„åˆ—
            display_df = job_df[['title', 'salary', 'location', 'status', 'created']]
            display_df.columns = ['èŒä½åç§°', 'è–ªèµ„', 'åœ°ç‚¹', 'çŠ¶æ€', 'å‘å¸ƒæ—¥æœŸ']
            st.dataframe(display_df, use_container_width=True)
        else:
            st.info("æš‚æ— èŒä½æ•°æ®")
    
    with tab2:
        with st.form("new_job_form"):
            title = st.text_input("èŒä½åç§° *", placeholder="ä¾‹å¦‚ï¼šå‰ç«¯å¼€å‘å·¥ç¨‹å¸ˆ")
            salary_min = st.number_input("æœ€ä½è–ªèµ„ï¼ˆå…ƒ/å¤©ï¼‰", min_value=0, value=200, step=50)
            salary_max = st.number_input("æœ€é«˜è–ªèµ„ï¼ˆå…ƒ/å¤©ï¼‰", min_value=0, value=500, step=50)
            location = st.selectbox("å·¥ä½œåœ°ç‚¹", ["è¿œç¨‹", "ä¸Šæµ·", "åŒ—äº¬", "æ·±åœ³", "æ­å·", "å¹¿å·", "æˆéƒ½"])
            skills = st.text_input("æŠ€èƒ½è¦æ±‚", placeholder="ç”¨é€—å·åˆ†éš”ï¼Œä¾‹å¦‚ï¼šPython, React, Vue")
            description = st.text_area("èŒä½æè¿°", height=100)
            
            col1, col2, col3 = st.columns(3)
            with col2:
                submitted = st.form_submit_button("ğŸ“¢ å‘å¸ƒèŒä½", use_container_width=True)
            
            if submitted:
                if title and skills:
                    new_job = {
                        "id": f"job_{len(jobs)+1:03d}",
                        "title": title,
                        "salary": f"{salary_min}-{salary_max}å…ƒ/å¤©",
                        "location": location,
                        "skills": [s.strip() for s in skills.split(",") if s.strip()],
                        "description": description,
                        "status": "æ‹›è˜ä¸­",
                        "created": datetime.now().strftime("%Y-%m-%d"),
                        "applicants": 0
                    }
                    
                    if USE_LOCAL_DATA:
                        dm.add_job(new_job)
                    else:
                        jobs.append(new_job)
                    
                    st.success(f"âœ… èŒä½å‘å¸ƒæˆåŠŸï¼")
                    st.balloons()
                else:
                    st.error("âŒ èŒä½åç§°å’ŒæŠ€èƒ½è¦æ±‚ä¸èƒ½ä¸ºç©ºï¼")

# ==================== å€™é€‰äººç®¡ç† ====================
elif page == "ğŸ‘¥ å€™é€‰äººç®¡ç†":
    st.markdown('<div class="main-header"><h1>ğŸ‘¥ å€™é€‰äººç®¡ç†</h1></div>', unsafe_allow_html=True)
    
    tab1, tab2 = st.tabs(["ğŸ‘¥ å€™é€‰äººåˆ—è¡¨", "â• æ·»åŠ å€™é€‰äºº"])
    
    with tab1:
        if candidates:
            candidate_data = []
            for c in candidates:
                candidate_data.append({
                    "å§“å": c['name'],
                    "æŠ€èƒ½": ", ".join(c['skills'][:3]),
                    "ç»éªŒ": f"{c['experience']}å¹´",
                    "æœŸæœ›è–ªèµ„": f"{c['expected_salary']}å…ƒ/å¤©",
                    "çŠ¶æ€": c['status']
                })
            df = pd.DataFrame(candidate_data)
            st.dataframe(df, use_container_width=True)
        else:
            st.info("æš‚æ— å€™é€‰äººæ•°æ®")
    
    with tab2:
        with st.form("new_candidate_form"):
            name = st.text_input("å§“å *")
            skills = st.text_input("æŠ€èƒ½ *", placeholder="ç”¨é€—å·åˆ†éš”")
            experience = st.number_input("å·¥ä½œç»éªŒï¼ˆå¹´ï¼‰", min_value=0, max_value=50, value=3)
            salary = st.number_input("æœŸæœ›è–ªèµ„ï¼ˆå…ƒ/å¤©ï¼‰", min_value=0, value=300, step=50)
            
            col1, col2, col3 = st.columns(3)
            with col2:
                submitted = st.form_submit_button("â• æ·»åŠ å€™é€‰äºº", use_container_width=True)
            
            if submitted:
                if name and skills:
                    new_candidate = {
                        "id": f"cand_{len(candidates)+1:03d}",
                        "name": name,
                        "skills": [s.strip() for s in skills.split(",") if s.strip()],
                        "experience": experience,
                        "expected_salary": salary,
                        "status": "å¯è”ç³»"
                    }
                    
                    if USE_LOCAL_DATA:
                        dm.add_candidate(new_candidate)
                    else:
                        candidates.append(new_candidate)
                    
                    st.success(f"âœ… å€™é€‰äºº {name} æ·»åŠ æˆåŠŸï¼")
                else:
                    st.error("âŒ å§“åå’ŒæŠ€èƒ½ä¸èƒ½ä¸ºç©ºï¼")

# ==================== åˆåŒç®¡ç† ====================
elif page == "ğŸ“„ åˆåŒç®¡ç†":
    st.markdown('<div class="main-header"><h1>ğŸ“„ åˆåŒç®¡ç†</h1></div>', unsafe_allow_html=True)
    
    col1, col2 = st.columns([2, 1])
    
    with col1:
        if contracts:
            contract_data = []
            for c in contracts:
                contract_data.append({
                    "åˆåŒç¼–å·": c['id'],
                    "èŒä½": c['job_title'],
                    "å€™é€‰äºº": c['candidate_name'],
                    "å¼€å§‹æ—¥æœŸ": c['start_date'],
                    "ç»“æŸæ—¥æœŸ": c['end_date'],
                    "çŠ¶æ€": c['status'],
                    "é‡‘é¢": f"Â¥{c['total_amount']:,}"
                })
            df = pd.DataFrame(contract_data)
            st.dataframe(df, use_container_width=True)
        else:
            st.info("æš‚æ— åˆåŒæ•°æ®")
    
    with col2:
        st.subheader("ğŸ“Š åˆåŒç»Ÿè®¡")
        total_amount = sum(c.get('total_amount', 0) for c in contracts)
        active_contracts = len([c for c in contracts if c['status'] == 'æ‰§è¡Œä¸­'])
        
        st.metric("åˆåŒæ€»é‡‘é¢", f"Â¥{total_amount:,}")
        st.metric("æ‰§è¡Œä¸­åˆåŒ", active_contracts)
        
        st.subheader("â• æ–°å»ºåˆåŒ")
        st.info("åˆåŒåˆ›å»ºåŠŸèƒ½å¼€å‘ä¸­...")

# ==================== æ™ºèƒ½åŒ¹é… ====================
elif page == "ğŸ¯ æ™ºèƒ½åŒ¹é…":
    st.markdown('<div class="main-header"><h1>ğŸ¯ æ™ºèƒ½åŒ¹é…</h1></div>', unsafe_allow_html=True)
    
    col1, col2 = st.columns([1, 1])
    
    with col1:
        st.subheader("é€‰æ‹©èŒä½")
        job_options = [f"{j['title']} - {j['location']}" for j in jobs if j['status'] == 'æ‹›è˜ä¸­']
        if job_options:
            selected_job = st.selectbox("èŒä½åˆ—è¡¨", job_options)
            
            if st.button("å¼€å§‹åŒ¹é…", type="primary", use_container_width=True):
                # ç®€å•çš„åŒ¹é…ç®—æ³•
                results = []
                for candidate in candidates:
                    if candidate['status'] in ['å¯è”ç³»', 'å¾…é¢è¯•']:
                        # éšæœºåŒ¹é…åº¦ï¼ˆå®é™…åº”ç”¨ä¸­åº”è¯¥æ˜¯çœŸæ­£çš„ç®—æ³•ï¼‰
                        import random
                        score = random.randint(60, 98)
                        results.append({
                            "å€™é€‰äºº": candidate['name'],
                            "æŠ€èƒ½": ", ".join(candidate['skills'][:3]),
                            "åŒ¹é…åº¦": f"{score}%",
                            "çŠ¶æ€": candidate['status']
                        })
                
                if results:
                    results.sort(key=lambda x: int(x['åŒ¹é…åº¦'][:-1]), reverse=True)
                    st.session_state['match_results'] = results
                else:
                    st.warning("æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„å€™é€‰äºº")
        else:
            st.warning("æš‚æ— æ‹›è˜ä¸­çš„èŒä½")
    
    with col2:
        st.subheader("åŒ¹é…ç»“æœ")
        if 'match_results' in st.session_state:
            df = pd.DataFrame(st.session_state['match_results'])
            st.dataframe(df, use_container_width=True)
        else:
            st.info("ç‚¹å‡»ã€Œå¼€å§‹åŒ¹é…ã€æŸ¥çœ‹ç»“æœ")

# ==================== æ•°æ®åˆ†æ ====================
else:
    st.markdown('<div class="main-header"><h1>ğŸ“Š æ•°æ®åˆ†æ</h1></div>', unsafe_allow_html=True)
    
    # æ•°æ®ç»Ÿè®¡
    col1, col2 = st.columns(2)
    
    with col1:
        st.subheader("èŒä½çŠ¶æ€åˆ†å¸ƒ")
        status_counts = {}
        for job in jobs:
            status = job['status']
            status_counts[status] = status_counts.get(status, 0) + 1
        
        status_df = pd.DataFrame({
            'çŠ¶æ€': list(status_counts.keys()),
            'æ•°é‡': list(status_counts.values())
        })
        st.bar_chart(status_df.set_index('çŠ¶æ€'))
    
    with col2:
        st.subheader("å€™é€‰äººæŠ€èƒ½åˆ†å¸ƒ")
        all_skills = []
        for c in candidates:
            all_skills.extend(c['skills'])
        
        from collections import Counter
        skill_counts = Counter(all_skills).most_common(5)
        
        if skill_counts:
            skill_df = pd.DataFrame({
                'æŠ€èƒ½': [s[0] for s in skill_counts],
                'æ•°é‡': [s[1] for s in skill_counts]
            })
            st.bar_chart(skill_df.set_index('æŠ€èƒ½'))
    
    # è¶‹åŠ¿åˆ†æ
    st.subheader("ğŸ“ˆ åˆåŒé‡‘é¢è¶‹åŠ¿")
    if contracts:
        contract_dates = []
        for c in contracts:
            try:
                date = datetime.strptime(c['start_date'], '%Y-%m-%d')
                contract_dates.append({
                    'æ—¥æœŸ': date,
                    'é‡‘é¢': c['total_amount']
                })
            except:
                pass
        
        if contract_dates:
            trend_df = pd.DataFrame(contract_dates)
            trend_df.set_index('æ—¥æœŸ', inplace=True)
            st.line_chart(trend_df)
    else:
        st.info("æš‚æ— åˆåŒæ•°æ®")

# é¡µè„š
st.sidebar.markdown("---")
st.sidebar.markdown("Â© 2024 çµæ´»ç”¨å·¥å¹³å°")
